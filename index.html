<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pot Noodle App</title>
  <meta name="description" content="A fun, interactive Pot Noodle cooking helper with step-by-step timers." />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#fbbf24;
      --accent2:#60a5fa;
      --good:#34d399;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% 10%, rgba(251,191,36,.18), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(96,165,250,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:16px 18px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent));
      display:grid;place-items:center;
      box-shadow: 0 10px 25px rgba(251,191,36,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .logo span{filter: drop-shadow(0 6px 14px rgba(0,0,0,.25)); font-size:20px}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:2px 0 0 0;color:var(--muted);font-size:12.5px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;color:rgba(255,255,255,.9);
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,24,39,.55);
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(15,23,42,.55);
    }
    .card .bd{padding:14px 16px}
    .title{font-weight:800;font-size:14.5px}
    .tiny{font-size:12px;color:var(--muted)}

    .row{display:flex;gap:10px;flex-wrap:wrap}

    select, button, input[type="range"]{font:inherit}
    select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,24,39,.65);
      color:var(--text);
      outline:none;
    }

    .controls{display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width: 520px){.controls{grid-template-columns:1fr}}

    .seg{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,24,39,.5);
      border-radius:14px;
    }
    .seg button{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,23,42,.6);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      flex:1;
      min-width:120px;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .seg button:hover{transform: translateY(-1px)}
    .seg button.active{
      border-color: rgba(251,191,36,.7);
      background: rgba(251,191,36,.12);
      box-shadow: 0 10px 25px rgba(251,191,36,.12);
    }

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button.primary{
      background:linear-gradient(180deg, rgba(251,191,36,.95), rgba(251,191,36,.72));
      border:none;color:#111827;
      padding:12px 14px;border-radius:14px;
      cursor:pointer;font-weight:900;
      box-shadow: 0 14px 35px rgba(251,191,36,.18);
      transition: transform .08s ease;
    }
    button.primary:hover{transform: translateY(-1px)}
    button.ghost{
      background:rgba(17,24,39,.35);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      cursor:pointer;font-weight:700;
      transition: transform .08s ease;
    }
    button.ghost:hover{transform: translateY(-1px)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.55);
      color:rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(52,211,153,.6);background: rgba(52,211,153,.10)}
    .badge.bad{border-color: rgba(251,113,133,.6);background: rgba(251,113,133,.10)}

    .desc{color:rgba(229,231,235,.95);line-height:1.45;font-size:14px}
    .muted{color:var(--muted)}

    .progress{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width .15s linear;
    }

    .stepper{display:grid;gap:10px}
    .step{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,24,39,.40);
      border-radius:16px;
      padding:12px;
      display:grid;gap:8px;
      position:relative;
      overflow:hidden;
    }
    .step.current{
      border-color: rgba(96,165,250,.65);
      box-shadow: 0 14px 35px rgba(96,165,250,.12);
      background: linear-gradient(180deg, rgba(96,165,250,.10), rgba(17,24,39,.35));
    }
    .step.done{
      border-color: rgba(52,211,153,.55);
      background: linear-gradient(180deg, rgba(52,211,153,.10), rgba(17,24,39,.35));
    }

    .stephd{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}

    /* Journey UI */
    .journeyNav{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:14px}
    .journeyNav button.ghost{padding:10px 12px}
    .journeyPips{display:flex;gap:8px;align-items:center;justify-content:center;flex:1}
    .pip{width:10px;height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06)}
    .pip.active{background:rgba(251,191,36,.85);border-color:rgba(251,191,36,.85);box-shadow:0 10px 25px rgba(251,191,36,.18)}

    .screens{margin-top:14px}
    .screen{display:none}
    .screen.active{display:block}

    /* Floating dock */
    .dock{position:fixed;left:0;right:0;bottom:0;padding:12px;z-index:20;pointer-events:none}
    .dockInner{max-width:1100px;margin:0 auto;pointer-events:auto;display:flex;align-items:center;justify-content:space-between;gap:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,23,42,.86);
      backdrop-filter: blur(12px);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px 12px;
    }
    .bigtime{font-variant-numeric: tabular-nums; font-size:28px; font-weight:950; letter-spacing:.5px}
    .dockTitle{display:flex;align-items:center;gap:8px}
    .spark{display:inline-block;animation: pop .9s ease-in-out infinite alternate;}
    @keyframes pop{to{transform: translateY(-1px) rotate(-2deg)}}

    .tbtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tbtns button{
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(17,24,39,.45);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }

    @media (max-width: 720px){
      .dockInner{flex-direction:column;align-items:stretch}
      .tbtns{justify-content:space-between}
      .bigtime{font-size:26px}
    }

    /* Make room for dock so it doesn‚Äôt cover content */
    #screen-cook .bd{padding-bottom:140px}

    .hint{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,24,39,.35);
      display:grid;gap:8px
    }
    .hint ul{margin:0;padding-left:18px;color:rgba(229,231,235,.92)}
    .hint li{margin:6px 0}

    .footerNote{margin-top:12px;color:var(--muted);font-size:12px;line-height:1.35}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.55);
      color:rgba(255,255,255,.92)
    }

    .toast{
      position:fixed;
      bottom:84px;left:50%;transform:translateX(-50%);
      background:rgba(17,24,39,.82);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      opacity:0;pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:999;
      max-width:min(92vw, 760px);
      text-overflow: ellipsis;
      overflow:hidden;
      white-space:nowrap;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:998}
    .c{
      position:absolute;top:-10px;
      width:10px;height:14px;
      border-radius:3px;
      opacity:.95;
      animation: fall linear forwards;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.2));
    }
    @keyframes fall{ to{transform: translateY(calc(100vh + 30px)) rotate(720deg); opacity:1} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üçú</span></div>
        <div>
          <h1>Pot Noodle App</h1>
          <p class="sub">A silly little noodle quest with timers (and vibes)</p>
        </div>
      </div>
      <div class="pillrow" aria-label="quick tips">
        <div class="pill">üß≠ Journey mode</div>
        <div class="pill">‚è±Ô∏è Floating timer dock</div>
        <div class="pill">‚ú® Flavour hacks</div>
      </div>
    </header>

    <nav class="journeyNav" aria-label="Journey navigation">
      <button class="ghost" id="navBack" disabled>‚Üê Back</button>
      <div class="journeyPips" aria-hidden="true">
        <span class="pip active" data-pip="start"></span>
        <span class="pip" data-pip="setup"></span>
        <span class="pip" data-pip="hacks"></span>
        <span class="pip" data-pip="cook"></span>
      </div>
      <button class="ghost" id="navHome">‚Ü∫ Back to start</button>
    </nav>

    <main class="screens">
      <!-- Screen: Start -->
      <section class="screen active" id="screen-start" data-screen="start" aria-label="Start">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Welcome, Noodle Adventurer</div>
              <div class="tiny">Your mission: turn dry bricks into saucy glory.</div>
            </div>
            <div class="badge">üéí Quest</div>
          </div>
          <div class="bd">
            <div class="desc" style="font-size:15px">
              You‚Äôll go through 3 rooms:
              <ol style="margin:10px 0 0 0; padding-left:18px">
                <li><strong>Choose</strong> your flavour + vibe</li>
                <li><strong>Power-ups</strong> (optional flavour hacks)</li>
                <li><strong>Boss fight</strong>: cooking steps with a floating timer dock</li>
              </ol>
            </div>
            <div class="btnrow" style="margin-top:14px">
              <button class="primary" id="begin">Begin the quest ‚ñ∂</button>
              <button class="ghost" id="surpriseStart">üé≤ Surprise me</button>
            </div>
            <div class="footerNote">Safety: boiling water is hot. Follow your pack if it differs.</div>
          </div>
        </div>
      </section>

      <!-- Screen: Setup -->
      <section class="screen" id="screen-setup" data-screen="setup" aria-label="Setup">
        <section class="card" aria-label="setup">
          <div class="hd">
            <div>
              <div class="title">Room 1: Choose your loadout</div>
              <div class="tiny">Pick your pot, method, and texture preference.</div>
            </div>
            <div class="badge" id="packBadge">‚Äî</div>
          </div>
          <div class="bd">
            <label class="tiny" for="flavour">Flavour / product</label>
            <select id="flavour"></select>

            <div class="controls" style="margin-top:12px">
              <div>
                <div class="tiny">Cooking method</div>
                <div class="seg" id="methodSeg" role="tablist" aria-label="Cooking method"></div>
              </div>

              <div>
                <div class="tiny">Texture preference</div>
                <div class="seg" id="textureSeg" role="tablist" aria-label="Texture preference">
                  <button type="button" data-texture="sloppy" class="active">ü•£ Sloppy</button>
                  <button type="button" data-texture="classic">üëå Classic</button>
                  <button type="button" data-texture="dry">üç¥ Dry</button>
                </div>
                <div class="tiny" style="margin-top:10px">Sauciness knob (just for fun)</div>
                <input id="sauceKnob" type="range" min="0" max="100" value="50" style="width:100%" />
              </div>
            </div>

            <div class="btnrow">
              <button class="primary" id="build">Lock it in ‚ñ∂</button>
              <button class="ghost" id="surprise">üé≤ Surprise me</button>
              <button class="ghost" id="resetAll">Reset</button>
            </div>

            <div class="footerNote">
              <strong>Heads up:</strong> Always follow the instructions on <em>your</em> pack if they differ.
              Hot water + noodles = lava. ü•µ
            </div>
          </div>
        </section>
      </section>

      <!-- Screen: Hacks -->
      <section class="screen" id="screen-hacks" data-screen="hacks" aria-label="Hacks">
        <aside class="card" aria-label="hints">
          <div class="hd">
            <div>
              <div class="title">Room 2: Optional power-ups</div>
              <div class="tiny">Pick one. Or don‚Äôt. Your destiny is yours.</div>
            </div>
            <div class="badge">‚ú®</div>
          </div>
          <div class="bd">
            <div class="hint">
              <div class="title" style="font-size:14px">For your selected flavour:</div>
              <div class="desc" id="flavourDesc">Pick a flavour to see what‚Äôs in the pot and the best add-ons.</div>
              <div class="progress" aria-hidden="true"><div class="bar" id="knobBar"></div></div>
              <div class="tiny">Your sauciness level: <span id="knobLabel">50</span>/100</div>
              <ul id="hintList"></ul>
              <div class="tiny muted" id="sachetNote"></div>
            </div>

            <div class="btnrow" style="margin-top:14px">
              <button class="primary" id="toCook">Enter cook mode ‚ñ∂</button>
              <button class="ghost" id="reroll">üîÅ Reroll hacks</button>
            </div>

            <div class="footerNote" style="margin-top:12px">
              Pro-tip: Keep a fork nearby. You‚Äôre about to become a <span class="kbd">stir-based athlete</span>.
            </div>
          </div>
        </aside>
      </section>

      <!-- Screen: Cook -->
      <section class="screen" id="screen-cook" data-screen="cook" aria-label="Cook">
        <section class="card" aria-label="steps">
          <div class="hd">
            <div>
              <div class="title">Room 3: Boss fight (cooking)</div>
              <div class="tiny">Use the floating dock at the bottom. One button: Next.</div>
            </div>
            <div class="row">
              <div class="badge" id="statusBadge">Waiting‚Ä¶</div>
              <div class="badge" id="totalTimeBadge">Total: ‚Äî</div>
            </div>
          </div>
          <div class="bd">
            <div class="stepper" id="stepper"></div>

            <div class="footerNote" style="margin-top:14px">
              Keyboard: <span class="kbd">Space</span> next/start ‚Ä¢ <span class="kbd">R</span> restart timer step ‚Ä¢ <span class="kbd">M</span> mute
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- Floating timer dock (only shown on cook screen) -->
  <div class="dock" id="dock" aria-label="Floating timer controls" style="display:none">
    <div class="dockInner">
      <div>
        <div class="dockTitle">
          <div class="tiny" id="activeStepName">No steps yet</div>
          <span class="spark" aria-hidden="true">‚ú®</span>
        </div>
        <div class="bigtime" id="time">00:00</div>
        <div class="tiny muted" id="activeTip">Build steps to begin.</div>
        <div class="progress" style="margin-top:8px" aria-label="timer progress"><div class="bar" id="progressBar"></div></div>
      </div>
      <div class="tbtns">
        <button id="next" disabled>Next ‚ñ∂</button>
        <button id="restart" disabled>‚Ü∫ Restart</button>
        <button id="mute">üîä Sound on</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    // Pot Noodle App ‚Äî single-file, GitHub Pages friendly.
    // Data sources used to build these steps (summary):
    // - Standard pot prep pattern (fill line + 2 min + stir + sachet + 2 min): Unilever Food Solutions product prep steps.
    // - Lost the Pot (packet) hob/microwave: Tesco product pages list hob + microwave instructions.
    // - Some add-on tips: Pot Noodle FAQ.

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const PRODUCTS = [
      { id:'pot_chicken_mushroom', name:'Pot Noodle ‚Äî Chicken & Mushroom', type:'pot', hasSachet:true, sachetLabel:'Soy sauce sachet',
        description:'Chicken & mushroom vibes with veg + a little soy sachet on many packs.', hints:['Add some cheese for a melty, indulgent upgrade. üßÄ'], defaultMethod:'kettle' },
      { id:'pot_beef_tomato', name:'Pot Noodle ‚Äî Beef & Tomato', type:'pot', hasSachet:true, sachetLabel:'Sauce sachet (varies by pack)',
        description:'Beef & tomato sauce-y goodness. Sachet varies by pack ‚Äî check your lid!', hints:['Try adding croutons for extra bite. ü•ñ'], defaultMethod:'kettle' },
      { id:'pot_bombay_bad_boy', name:'Pot Noodle ‚Äî Bombay Bad Boy', type:'pot', hasSachet:true, sachetLabel:'Hot sauce sachet (common)',
        description:'Spicy curry-style noodles. If you‚Äôve got a sachet under the lid, you‚Äôre in business.', hints:['Add extra hot chilli sauce if you can handle it. üå∂Ô∏è'], defaultMethod:'kettle' },
      { id:'pot_original_curry', name:'Pot Noodle ‚Äî Original Curry', type:'pot', hasSachet:true, sachetLabel:'Sweet mango sauce sachet (common)',
        description:'Classic curry pot with a sweet mango sachet on many packs.', hints:['Throw in some diced tomatoes to switch it up. üçÖ'], defaultMethod:'kettle' },
      { id:'pot_sweet_sour', name:'Pot Noodle ‚Äî Sweet & Sour', type:'pot', hasSachet:true, sachetLabel:'Sweet & sour sauce sachet',
        description:'Sweet & sour flavour with veg + a little extra sauce sachet on many packs.', hints:['Add spring onions if you‚Äôre feeling fancy. üßÖ'], defaultMethod:'kettle' },
      { id:'pot_sticky_rib', name:"Pot Noodle ‚Äî Sticky Rib", type:'pot', hasSachet:true, sachetLabel:'Sauce sachet (varies by pack)',
        description:'Sticky, savoury, glorious. Check your lid for a sachet before you begin.', hints:['Add a pinch of smoked paprika or BBQ sauce to lean into it. üî•'], defaultMethod:'kettle' },

      { id:'lost_smokin_bqq', name:"Lost the Pot ‚Äî Smokin' BBQ (packet)", type:'lost', hasSachet:true, sachetLabel:'Seasoning sachet',
        description:'No pot. Big freedom. Cook on hob or microwave (in a microwave-safe dish).', hints:['Add peas / carrots / stir-fry veg for instant grown-up points. ü•ï'], defaultMethod:'microwave' },
      { id:'lost_champion_chicken', name:"Lost the Pot ‚Äî Champion Chicken (packet)", type:'lost', hasSachet:true, sachetLabel:'Seasoning sachet',
        description:'No pot. All power. Cook on hob or microwave (in a microwave-safe dish).', hints:['Add leftover roast chicken if you‚Äôve got it. üêî'], defaultMethod:'microwave' },
    ];

    const METHODS = {
      kettle: { id:'kettle', label:'‚ô®Ô∏è Kettle (boiling water)', allowedTypes:['pot'] },
      microwave: { id:'microwave', label:'üì° Microwave (dish)', allowedTypes:['lost'] },
      hob: { id:'hob', label:'üç≥ Hob (pan)', allowedTypes:['lost'] },
    };

    const GENERAL_HACKS = [
      'Add a knob of butter for glossy sauce. üßà',
      'A squeeze of lime/lemon wakes it up. üçã',
      'Crispy onions / chilli crisp = instant upgrade. üßÖüå∂Ô∏è',
      'A few drops of sesame oil for ‚Äútakeaway aroma‚Äù. üå∞',
      'Extra black pepper = "adult mode". üßë‚Äçüç≥',
      'Add a slice of cheese and stir like a maniac. üßÄ',
    ];

    const TIMEWELLSPENT = [
      'Practice your ‚Äústir face‚Äù in the mirror. üò§',
      'Perfect your fork twirl technique. üç¥',
      'Compose a haiku about noodles. üìù',
      'Do a heroic lap around the kitchen. üèÉ',
      'Text someone: ‚ÄúI‚Äôm busy. I‚Äôm cooking.‚Äù üíÖ',
      'Pretend you‚Äôre a TV chef: ‚Äúand now‚Ä¶ we wait.‚Äù üì∫',
    ];

    // Screens
    const screens = {
      start: $('#screen-start'),
      setup: $('#screen-setup'),
      hacks: $('#screen-hacks'),
      cook: $('#screen-cook'),
    };
    const navBack = $('#navBack');
    const navHome = $('#navHome');

    function setPip(active){
      $$('.pip').forEach(p => p.classList.toggle('active', p.dataset.pip===active));
    }

    let historyStack = ['start'];
    let currentScreen = 'start';

    function showScreen(name, push=true){
      for(const k of Object.keys(screens)) screens[k].classList.toggle('active', k===name);
      currentScreen = name;
      setPip(name);
      if(push){
        historyStack.push(name);
      }
      navBack.disabled = historyStack.length <= 1;
      dock.style.display = (name === 'cook') ? 'block' : 'none';

      const msg = {start:'Quest ready.', setup:'Choose your loadout.', hacks:'Power-ups acquired.', cook:'Boss fight: noodles.'}[name];
      if(msg) toastMsg(msg);
    }

    // UI elements
    const beginBtn = $('#begin');
    const surpriseStartBtn = $('#surpriseStart');

    const flavourSel = $('#flavour');
    const methodSeg = $('#methodSeg');
    const textureSeg = $('#textureSeg');
    const sauceKnob = $('#sauceKnob');

    const packBadge = $('#packBadge');
    const flavourDesc = $('#flavourDesc');
    const hintList = $('#hintList');
    const sachetNote = $('#sachetNote');
    const knobBar = $('#knobBar');
    const knobLabel = $('#knobLabel');

    const buildBtn = $('#build');
    const surpriseBtn = $('#surprise');
    const resetAllBtn = $('#resetAll');
    const toCookBtn = $('#toCook');
    const rerollBtn = $('#reroll');

    const stepper = $('#stepper');
    const statusBadge = $('#statusBadge');
    const totalTimeBadge = $('#totalTimeBadge');

    // Dock
    const dock = $('#dock');
    const activeStepName = $('#activeStepName');
    const timeEl = $('#time');
    const activeTip = $('#activeTip');
    const progressBar = $('#progressBar');
    const nextBtn = $('#next');
    const restartBtn = $('#restart');
    const muteBtn = $('#mute');

    const toast = $('#toast');
    const confetti = $('#confetti');

    // State
    let state = {
      productId: PRODUCTS[0].id,
      method: PRODUCTS[0].defaultMethod,
      texture: 'sloppy',
      knob: 50,
      steps: [],
      stepIndex: 0,
      running: false,
      remaining: 0,
      duration: 0,
      tickHandle: null,
      muted: false,
    };

    function fmt(sec){
      sec = Math.max(0, Math.round(sec));
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toast.classList.remove('show'), 2200);
    }

    function beep(type='done'){
      if(state.muted) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = type==='done' ? 880 : 440;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
        setTimeout(()=>ctx.close(), 260);
      } catch(e) {}
    }

    function spawnConfetti(){
      confetti.innerHTML = '';
      const n = 28;
      for(let i=0;i<n;i++){
        const el = document.createElement('div');
        el.className = 'c';
        el.style.left = Math.random()*100 + 'vw';
        el.style.animationDuration = (2.4 + Math.random()*1.4) + 's';
        el.style.transform = `translateY(-10px) rotate(${Math.random()*120}deg)`;
        el.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 65%)`;
        confetti.appendChild(el);
      }
      setTimeout(()=> confetti.innerHTML='', 3400);
    }

    function currentProduct(){
      return PRODUCTS.find(p => p.id === state.productId) || PRODUCTS[0];
    }

    function allowedMethodsFor(product){
      return Object.values(METHODS).filter(m => m.allowedTypes.includes(product.type));
    }

    function buildMethodButtons(){
      const p = currentProduct();
      const allowed = allowedMethodsFor(p);
      if(!allowed.some(m => m.id === state.method)) state.method = p.defaultMethod;

      methodSeg.innerHTML = '';
      for(const m of allowed){
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = m.label;
        b.dataset.method = m.id;
        if(m.id === state.method) b.classList.add('active');
        b.addEventListener('click', () => {
          state.method = m.id;
          buildMethodButtons();
          toastMsg(`Method set: ${m.label}`);
        });
        methodSeg.appendChild(b);
      }
    }

    function updateHints(){
      const p = currentProduct();
      packBadge.textContent = p.type === 'pot' ? 'POT (in a pot)' : 'LOST THE POT (packet)';
      flavourDesc.textContent = p.description;

      hintList.innerHTML = '';
      const list = [];

      // Flavour-specific
      for(const h of p.hints || []) list.push(h);

      // Texture guidance
      if(state.texture === 'dry') list.push('Dry mode: aim just under the fill line / slightly less liquid.');
      if(state.texture === 'sloppy') list.push('Sloppy mode: fill to the line (or a tiny splash more if you like it looser).');
      if(state.texture === 'classic') list.push('Classic mode: fill to the line. No drama.');

      // Knob guidance
      if(state.knob >= 80) list.push('Sauciness 80+? Consider extra soy / chilli crisp / ketchup (choose your chaos).');
      if(state.knob <= 20) list.push('Sauciness 20-? Stir well and let it sit a touch longer (thicker vibes).');

      // General hacks (random 2)
      const g = GENERAL_HACKS.slice().sort(()=>Math.random()-0.5).slice(0,2);
      list.push(...g);

      for(const item of list){
        const li = document.createElement('li');
        li.textContent = item;
        hintList.appendChild(li);
      }

      sachetNote.textContent = p.hasSachet
        ? `‚úÖ This one typically includes a sachet: ${p.sachetLabel}. (Always check your pack.)`
        : '‚ÑπÔ∏è No sachet expected (always check your pack).';

      knobLabel.textContent = String(state.knob);
      knobBar.style.width = state.knob + '%';
    }

    function setTexture(tex){
      state.texture = tex;
      $$('#textureSeg button').forEach(b => b.classList.toggle('active', b.dataset.texture === tex));
      updateHints();
    }

    function stepsFor(product, method){
      const sauceMsg = (product.hasSachet)
        ? `Remove the sachet and keep it safe. (This is not a snack. Yet.)`
        : `No sachet? Cool. Your future self thanks you.`;

      const textureTip = (function(){
        if(state.texture==='dry') return 'Dry mode: aim slightly under the fill line (thicker sauce).';
        if(state.texture==='sloppy') return 'Sloppy mode: fill to the line (or a tiny splash more if you like it looser).';
        return 'Classic mode: fill to the line. No drama.';
      })();

      if(product.type === 'pot'){
        return [
          { id:'open', name:'Peel lid + locate sachet', duration:0, kind:'action', text:`Peel the lid back halfway. ${sauceMsg}` },
          { id:'water', name:'Add boiling water', duration:0, kind:'action', text:`Pour boiling water in to the fill line. ${textureTip} Re-cover with the lid.` },
          { id:'wait1', name:'Wait (steam magic)', duration:120, kind:'timer', text:`Leave it for 2 minutes. Time well spent: ${TIMEWELLSPENT[Math.floor(Math.random()*TIMEWELLSPENT.length)]}` },
          { id:'stir1', name:'Stir like you mean it', duration:0, kind:'action', text:`Stir thoroughly. Scrape the corners. Free the flavour.` },
          { id:'sachet', name:'Add sachet', duration:0, kind:'action', text: product.hasSachet ? `Add the sachet contents now (${product.sachetLabel}). Stir again.` : `If your pack has a sachet, add it now. If not, proceed. Stir again.` },
          { id:'wait2', name:'Wait (final form)', duration:120, kind:'timer', text:`Leave for another 2 minutes. Your noodles are evolving‚Ä¶` + (state.texture==='dry' ? ' (Dry mode bonus: leave it an extra 20‚Äì30 seconds if you want it thicker.)' : '') },
          { id:'eat', name:'Eat while it‚Äôs hot', duration:0, kind:'action', text:`Stir once more and tuck in. Warning: it will be hot. Victory tastes like noodles.` },
        ];
      }

      if(method === 'hob'){
        return [
          { id:'pan', name:'Boil water in a pan', duration:0, kind:'action', text:`Bring 300 ml of water to the boil in a pan.` },
          { id:'add', name:'Add noodles + sachet', duration:0, kind:'action', text:`Add noodles. Stir in the sachet contents.` },
          { id:'simmer', name:'Simmer', duration:180, kind:'timer', text:`Reduce the heat slightly and simmer for 3 minutes, stirring occasionally, until liquid is absorbed.` },
          { id:'serve', name:'Stir & serve', duration:0, kind:'action', text:`Stir, taste, and serve. (Optional: add veggies for extra glory.)` },
        ];
      }

      // Microwave
      return [
        { id:'dish', name:'Microwave-safe dish', duration:0, kind:'action', text:`Add noodles and sachet contents to a large microwave-safe dish.` },
        { id:'water', name:'Add boiling water', duration:0, kind:'action', text:`Pour over 300 ml of boiling water and cover the dish.` },
        { id:'cook', name:'Microwave on high', duration:300, kind:'timer', text:`Cook on high for 5 minutes, stirring occasionally, until liquid is absorbed.` },
        { id:'serve', name:'Stir & serve', duration:0, kind:'action', text:`Stir and serve. Congratulations. You have mastered ‚Äúno pot‚Äù.` },
      ];
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function renderSteps(){
      stepper.innerHTML = '';
      const steps = state.steps;
      for(let i=0;i<steps.length;i++){
        const s = steps[i];
        const el = document.createElement('div');
        el.className = 'step';
        if(i < state.stepIndex) el.classList.add('done');
        if(i === state.stepIndex) el.classList.add('current');

        const hd = document.createElement('div');
        hd.className = 'stephd';

        const left = document.createElement('div');
        left.innerHTML = `<div class="title">${i+1}. ${escapeHtml(s.name)}</div><div class="tiny muted">${s.kind==='timer' ? `‚è±Ô∏è Timed: ${fmt(s.duration)}` : '‚úÖ Action step'}</div>`;

        const right = document.createElement('div');
        const badge = document.createElement('div');
        badge.className = 'badge ' + (i < state.stepIndex ? 'good' : (i===state.stepIndex ? '' : ''));
        badge.textContent = i < state.stepIndex ? 'Done' : (i===state.stepIndex ? 'Now' : 'Next');
        right.appendChild(badge);

        hd.appendChild(left);
        hd.appendChild(right);

        const d = document.createElement('div');
        d.className = 'desc';
        d.textContent = s.text;

        const jump = document.createElement('div');
        jump.className = 'row';
        jump.style.justifyContent = 'space-between';
        jump.style.alignItems = 'center';

        const mini = document.createElement('div');
        mini.className = 'tiny muted';
        mini.textContent = s.kind==='timer' ? 'Dock tip: Next = start timer. Next again = skip (if running).' : 'Dock tip: press Next when you‚Äôre done.';

        const go = document.createElement('button');
        go.className = 'ghost';
        go.style.padding = '10px 12px';
        go.textContent = (i===state.stepIndex) ? 'Focus this step' : 'Jump here';
        go.addEventListener('click', () => {
          stopTimer();
          state.stepIndex = i;
          syncActiveStep();
          toastMsg(`Jumped to step ${i+1}`);
        });

        jump.appendChild(mini);
        jump.appendChild(go);

        el.appendChild(hd);
        el.appendChild(d);
        el.appendChild(jump);
        stepper.appendChild(el);
      }

      const total = steps.reduce((sum,s)=>sum+(s.kind==='timer'?s.duration:0),0);
      totalTimeBadge.textContent = `Total: ${fmt(total)}`;
    }

    function updateProgressBar(){
      if(state.duration <= 0){
        progressBar.style.width = '0%';
        return;
      }
      const pct = 100 * (1 - (state.remaining / state.duration));
      progressBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
    }

    function nextButtonLabel(){
      const s = state.steps[state.stepIndex];
      if(!s) return 'Next ‚ñ∂';
      if(s.kind === 'timer'){
        if(state.running) return 'Next ‚è≠';
        // not running
        if(state.remaining < s.duration) return 'Resume ‚ñ∂';
        return 'Start ‚ñ∂';
      }
      return 'Next ‚ñ∂';
    }

    function syncActiveStep(){
      const steps = state.steps;
      const s = steps[state.stepIndex];

      if(!s){
        statusBadge.textContent = 'Waiting‚Ä¶';
        activeStepName.textContent = 'No steps yet';
        timeEl.textContent = '00:00';
        activeTip.textContent = 'Build steps to begin.';
        progressBar.style.width = '0%';
        nextBtn.disabled = true;
        restartBtn.disabled = true;
        renderSteps();
        return;
      }

      statusBadge.textContent = `Step ${state.stepIndex+1}/${steps.length}`;
      activeStepName.textContent = s.name;
      activeTip.textContent = s.text;

      if(s.kind === 'timer'){
        if(state.duration !== s.duration || state.remaining<=0 || (!state.running && state.remaining===0)){
          state.duration = s.duration;
          if(!state.running) state.remaining = s.duration;
        }
        timeEl.textContent = fmt(state.remaining);
        restartBtn.disabled = false;
      } else {
        state.duration = 0;
        state.remaining = 0;
        timeEl.textContent = '‚Äî';
        restartBtn.disabled = true;
      }

      nextBtn.disabled = false;
      nextBtn.textContent = nextButtonLabel();
      updateProgressBar();
      renderSteps();
    }

    function stopTimer(finished=false){
      if(state.tickHandle){
        clearInterval(state.tickHandle);
        state.tickHandle = null;
      }
      state.running = false;
      nextBtn.textContent = nextButtonLabel();
      if(!finished) updateProgressBar();
    }

    function startTimer(){
      const s = state.steps[state.stepIndex];
      if(!s || s.kind !== 'timer') return;
      if(state.running) return;

      state.running = true;
      nextBtn.textContent = nextButtonLabel();
      statusBadge.textContent = `Step ${state.stepIndex+1}/${state.steps.length} ‚Ä¢ running`;

      let last = performance.now();
      state.tickHandle = setInterval(() => {
        const now = performance.now();
        const dt = (now - last) / 1000;
        last = now;
        state.remaining -= dt;

        if(state.remaining <= 0){
          state.remaining = 0;
          timeEl.textContent = fmt(0);
          updateProgressBar();
          stopTimer(true);
          beep('done');
          toastMsg('Timer done! Auto-advancing‚Ä¶');
          nextStep();
          return;
        }

        timeEl.textContent = fmt(state.remaining);
        updateProgressBar();
      }, 120);
    }

    function restartStep(){
      const s = state.steps[state.stepIndex];
      if(!s || s.kind !== 'timer') return;
      stopTimer();
      state.duration = s.duration;
      state.remaining = s.duration;
      timeEl.textContent = fmt(state.remaining);
      updateProgressBar();
      toastMsg('Timer restarted. Round 2. Fight.');
      nextBtn.textContent = nextButtonLabel();
    }

    function nextStep(){
      stopTimer();
      state.stepIndex++;
      if(state.stepIndex >= state.steps.length){
        statusBadge.textContent = 'DONE üéâ';
        activeStepName.textContent = 'You did it.';
        timeEl.textContent = 'üçú';
        activeTip.textContent = 'Final move: stir once more and enjoy.';
        progressBar.style.width = '100%';
        nextBtn.disabled = true;
        restartBtn.disabled = true;
        spawnConfetti();
        beep('done');
        toastMsg('Legend status: unlocked.');
        renderSteps();
        return;
      }

      const s = state.steps[state.stepIndex];
      if(s.kind==='timer'){
        state.duration = s.duration;
        state.remaining = s.duration;
      }
      syncActiveStep();
      toastMsg(s.kind==='timer' ? 'Timer step ready. Press Start in the dock.' : 'Action step: do the thing, then Next.');
    }

    function buildSteps(){
      const p = currentProduct();
      state.steps = stepsFor(p, state.method);
      state.stepIndex = 0;
      state.running = false;
      state.remaining = 0;
      state.duration = 0;
      stopTimer();

      // Prime
      const s0 = state.steps[0];
      if(s0 && s0.kind==='timer'){
        state.duration = s0.duration;
        state.remaining = s0.duration;
      }

      syncActiveStep();
    }

    function randomProduct(){
      const p = PRODUCTS[Math.floor(Math.random()*PRODUCTS.length)];
      state.productId = p.id;
      state.method = p.defaultMethod;
      setTexture(['sloppy','classic','dry'][Math.floor(Math.random()*3)]);
      flavourSel.value = state.productId;
      buildMethodButtons();
      updateHints();
      buildSteps();
      toastMsg('Random loadout equipped.');
    }

    function resetAll(){
      stopTimer();
      state = {
        productId: PRODUCTS[0].id,
        method: PRODUCTS[0].defaultMethod,
        texture: 'sloppy',
        knob: 50,
        steps: [],
        stepIndex: 0,
        running: false,
        remaining: 0,
        duration: 0,
        tickHandle: null,
        muted: state.muted,
      };
      flavourSel.value = state.productId;
      sauceKnob.value = String(state.knob);
      setTexture('sloppy');
      buildMethodButtons();
      updateHints();
      syncActiveStep();
      toastMsg('Reset complete. Fresh pot energy.');
    }

    // Events
    function init(){
      // Dropdown
      for(const p of PRODUCTS){
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        flavourSel.appendChild(opt);
      }
      flavourSel.value = state.productId;

      buildMethodButtons();
      updateHints();
      syncActiveStep();

      // Nav
      navHome.addEventListener('click', () => {
        resetAll();
        historyStack = ['start'];
        showScreen('start', false);
      });
      navBack.addEventListener('click', () => {
        if(historyStack.length <= 1) return;
        historyStack.pop();
        const prev = historyStack[historyStack.length-1] || 'start';
        showScreen(prev, false);
      });

      beginBtn.addEventListener('click', () => showScreen('setup'));
      surpriseStartBtn.addEventListener('click', () => { randomProduct(); showScreen('cook'); });

      // Setup
      flavourSel.addEventListener('change', () => {
        stopTimer();
        state.productId = flavourSel.value;
        const p = currentProduct();
        state.method = p.defaultMethod;
        buildMethodButtons();
        updateHints();
        toastMsg('Selected. Lock it in to continue.');
      });

      $$('#textureSeg button').forEach(b => b.addEventListener('click', () => setTexture(b.dataset.texture)));

      sauceKnob.addEventListener('input', () => {
        state.knob = Number(sauceKnob.value);
        updateHints();
      });

      buildBtn.addEventListener('click', () => {
        buildSteps();
        toastMsg('Loadout locked. Power-ups next.');
        showScreen('hacks');
      });

      surpriseBtn.addEventListener('click', randomProduct);
      resetAllBtn.addEventListener('click', resetAll);

      // Hacks
      rerollBtn.addEventListener('click', () => {
        updateHints();
        toastMsg('Hacks rerolled. Chaos refreshed.');
      });
      toCookBtn.addEventListener('click', () => {
        if(state.steps.length === 0) buildSteps();
        showScreen('cook');
      });

      // Dock controls
      nextBtn.addEventListener('click', () => {
        const s = state.steps[state.stepIndex];
        if(!s) return;

        if(s.kind === 'timer'){
          if(state.running){
            stopTimer();
            beep('skip');
            toastMsg('Skipping ahead‚Ä¶');
            nextStep();
            return;
          }
          startTimer();
          toastMsg(state.remaining < s.duration ? 'Resumed!' : 'Timer started!');
          nextBtn.textContent = nextButtonLabel();
          return;
        }

        // action step
        beep('skip');
        nextStep();
      });

      restartBtn.addEventListener('click', restartStep);
      muteBtn.addEventListener('click', () => {
        state.muted = !state.muted;
        muteBtn.textContent = state.muted ? 'üîá Sound off' : 'üîä Sound on';
        toastMsg(state.muted ? 'Muted.' : 'Sound on.');
      });

      // Keyboard
      window.addEventListener('keydown', (e) => {
        const t = e.target;
        const isForm = t && (t.tagName==='SELECT' || t.tagName==='INPUT' || t.tagName==='TEXTAREA');
        if(isForm) return;

        if(e.code==='Space'){
          e.preventDefault();
          if(!nextBtn.disabled) nextBtn.click();
        } else if(e.key.toLowerCase()==='r'){
          if(!restartBtn.disabled) restartBtn.click();
        } else if(e.key.toLowerCase()==='m'){
          muteBtn.click();
        } else if(e.key==='Escape'){
          // quick exit to start
          navHome.click();
        }
      });

      // Start screen
      showScreen('start', false);
    }

    init();
  </script>
</body>
</html>
